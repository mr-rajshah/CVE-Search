# -*- coding: utf-8 -*-
import requests
import re
from termcolor import colored
from datetime import datetime

# Function to find Common Platform Enumeration (CPE) entries based on a component and version
def find_cpes(component, version):
    # Define the base URL for NVD's CPE search
    nvd_base_url = "https://nvd.nist.gov/products/cpe/search/results"

    # Set parameters for the search query
    params = {
        "namingFormat": "2.3",
        "keyword": f"{component} {version}"
    }

    # Make a web request to NVD to find CPEs
    response = requests.get(nvd_base_url, params=params)
    page_content = response.text

    # Use regular expression to extract CPEs from the response
    cpe_matches = re.findall(r'cpe:(.*?)<', page_content)
    return cpe_matches

# Function to retrieve Snyk Database information for a given CVE ID
def fetch_snyk_info(cve_id):
    # Define the URL for Snyk Database search
    snyk_url = f"https://security.snyk.io/vuln/?search={cve_id}"

    # Define a regular expression pattern to extract Snyk Short Name
    a_tag_pattern = r'data-snyk-test="vuln table title".*>([^"]+)<!----><!---->'

    # Make a web request to Snyk and extract the Short Name
    a_tag_matches = re.findall(a_tag_pattern, requests.get(snyk_url).text)

    if a_tag_matches:
        snyk_short_name = a_tag_matches[0].strip()
        return snyk_short_name

# Function to fetch CVE details using CPE strings
def fetch_cve_details(cpe_strings):
    # Define the base URL for NVD's CVE data
    nvd_api_url = "https://services.nvd.nist.gov/rest/json/cves/1.0"
    results = []

    for cpe_string in cpe_strings:
        # Extract the relevant part of the CPE string (vendor, product, version, update)
        cve_query_string = ":".join(cpe_string.split(":")[1:5])

        # Construct the URL to fetch CVE details for this CPE
        url = f"{nvd_api_url}?cpeMatchString=cpe:/{cve_query_string}"

        # Make a web request to NVD to fetch CVE details
        response = requests.get(url)
        cve_data = response.json()

        if "result" in cve_data:
            cve_items = cve_data["result"]["CVE_Items"]
            for cve_item in cve_items:
                cve_id = cve_item["cve"]["CVE_data_meta"]["ID"]
                snyk_short_name = fetch_snyk_info(cve_id)

                # Extract CVE details
                description = cve_item["cve"]["description"]["description_data"][0]["value"]
                link = f"https://nvd.nist.gov/vuln/detail/{cve_id}"

                weaknesses = []
                if "problemtype" in cve_item["cve"]:
                    for problem_type in cve_item["cve"]["problemtype"]["problemtype_data"]:
                        for desc in problem_type["description"]:
                            weaknesses.append(desc["value"])

                description_text = cve_item["cve"]["description"]["description_data"][0]["value"] if "description_data" in cve_item["cve"]["description"] else "Description not available."

                # Store CVE details in a dictionary
                cve_details = {
                    "CVE ID": cve_id,
                    "Short Name": snyk_short_name,
                    "Description": description_text,
                    "Weaknesses": ", ".join(weaknesses),
                    "Link": link
                }

                # Add the dictionary to the results list
                results.append(cve_details)

    return results

if __name__ == "__main__":
    # Get user input for component and version
    component = input("Enter the component (e.g., jquery): ")
    version = input("Enter the version (e.g., 1.0.0): ")

    # Find CPEs based on the provided component and version
    cpe_strings = find_cpes(component, version)

    if cpe_strings:
        # Fetch CVE details for the found CPEs
        results = fetch_cve_details(cpe_strings)

        # Display CVE details for each result
        for result in results:
            print("\nCVE Details")
            print(f"CVE ID: {result['CVE ID']}")
            if result["Short Name"]:
                print(f"Short Name: {result['Short Name']}")
            print(f"Description: {result['Description']}")
            if result["Weaknesses"]:
                print(f"Weaknesses: {result['Weaknesses']}")
            print(f"Link: {result['Link']}\n")
    else:
        print("CPEs not found for the provided component and version.")
